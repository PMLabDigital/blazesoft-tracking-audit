<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YayCasino | Paid Media Lab | Conversion Tracking Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chosen Palette: "Paid Media Lab Green" - Using a dark green (#2a5541) and cream (#f0f0e0) from the logo. The main background is a light cream, with the dark green used for accents, navigation, and branding to create a professional, consistent theme. -->
    <!-- Application Structure Plan: The SPA is structured into three distinct, navigable sections: "Dashboard," "Diagnosis," and "Action Plan." This task-oriented design allows different stakeholders to efficiently access relevant information. The Dashboard provides a high-level summary for executives, now featuring a funnel chart to show the massive conversion drop-off. The Diagnosis section offers a deep dive for developers. The Action Plan section provides a highly detailed, step-by-step implementation guide for project managers and team leads. This "What, Why, How" flow is intuitive and actionable. -->
    <!-- Visualization & Content Choices: 
    1. Conversion Discrepancy -> Goal: Compare stages of data loss -> Viz: Chart.js Horizontal Bar Chart (Funnel style) -> Interaction: Datalabels show exact numbers -> Justification: A funnel chart is the most effective way to visualize the dramatic 212 -> 50 -> 8 drop-off, making the core problem instantly understandable.
    2. Tracking Flowchart -> Goal: Organize user journey & show leakage -> Viz: Custom HTML/CSS Flexbox Diagram -> Interaction: Critical failure points are visually distinct -> Justification: A structured HTML diagram is responsive, accessible, and clearer than ASCII art.
    3. Root Causes -> Goal: Detail technical issues -> Viz: JS-powered Accordion -> Interaction: Click to expand/collapse -> Justification: Manages information density and allows users to focus on specific problems.
    4. Action Plan -> Goal: Provide an actionable roadmap -> Viz: Detailed Accordion -> Interaction: Expand tasks for "what, why, how" details -> Justification: Provides a high-level overview with essential drill-down capabilities, making the plan directly executable by the teams. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        :root {
            --brand-green: #2a5541;
            --brand-cream: #f0f0e0;
            --bg-cream: #fdfdfa;
            --text-dark: #333333;
            --text-light: #555555;
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-cream);
            color: var(--text-dark);
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 40vh;
            width: 100%;
            max-width: 800px;
            max-height: 350px;
        }
        .nav-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 600;
            color: var(--brand-green);
            border: 2px solid transparent;
        }
        .nav-item.active {
            background-color: var(--brand-green);
            color: white;
        }
        .nav-item:not(.active):hover {
            border-color: var(--brand-green);
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .accordion-header {
            cursor: pointer;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .logo-symbol {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--brand-cream);
            line-height: 1;
        }
        .diagram-step {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border: 1px solid var(--border-color);
            background-color: #ffffff;
            border-radius: 0.5rem;
            text-align: center;
            min-height: 60px;
            position: relative;
        }
        .diagram-arrow {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 3rem;
        }
        .diagram-arrow::after {
            content: '↓';
            font-size: 1.5rem;
            color: #9ca3af;
        }
        .leak-point {
            border-left: 3px solid #ef4444;
            padding-left: 1rem;
            margin-left: 2rem;
        }
        code {
            background-color: #eef2ff;
            color: #4338ca;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875em;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <header class="bg-white shadow-sm sticky top-0 z-10 border-b-2 border-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-[var(--brand-green)] flex items-center justify-center rounded-md">
                            <span class="logo-symbol">&gt;–</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Paid Media Lab</h1>
                            <p class="text-sm text-gray-500">Conversion-Tracking Audit: BlazeSoft Group (YayCasino) | Lead Consultant: Saku Fadiga</p>
                        </div>
                    </div>
                    <nav id="main-nav" class="mt-4 sm:mt-0 flex space-x-1">
                        <span class="nav-item active" data-view="dashboard">Dashboard</span>
                        <span class="nav-item" data-view="diagnosis">Diagnosis</span>
                        <span class="nav-item" data-view="plan">Action Plan</span>
                    </nav>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <section id="dashboard-view" class="content-section active">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-gray-900">Executive Summary</h2>
                    <p class="mt-2 text-lg text-gray-600 max-w-3xl mx-auto">BlazeSoft’s campaigns are handicapped by severe attribution gaps, with average under‑reporting reaching 80–90% for key conversion events. This audit isolates seven root causes and prescribes a staged remediation plan to bring platform‑to‑backend variance below the ≤ 15% threshold.</p>
                </div>

                <div class="kpi-card mb-8">
                    <h3 class="text-xl font-bold text-center mb-4">The Conversion Funnel Leak: Power BI vs. Meta (July 10-12)</h3>
                     <p class="text-center text-sm text-gray-500 mb-6">This chart illustrates the dramatic drop-off. For every 100 conversions logged in the backend, only 24 are received by Meta, and a mere 4 are correctly attributed to ads.</p>
                    <div class="chart-container">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="kpi-card border-l-4 border-red-500">
                        <h3 class="text-lg font-semibold text-gray-800">Backend Logic Flaw</h3>
                        <p class="text-sm text-gray-600 mt-2">The backend only sends a conversion event if a <code>fbclid</code> or <code>scid</code> is present. This is the primary cause of underreporting, as it discards all valid conversions from users without these IDs.</p>
                    </div>
                    <div class="kpi-card border-l-4 border-orange-500">
                        <h3 class="text-lg font-semibold text-gray-800">CAPI Payload Gaps</h3>
                        <p class="text-sm text-gray-600 mt-2">The Meta CAPI payload is missing the critical <code>_fbp</code> parameter, resulting in a poor <strong>6.2/10</strong> Event Match Quality and preventing event deduplication.</p>
                    </div>
                    <div class="kpi-card border-l-4 border-red-500">
                        <h3 class="text-lg font-semibold text-gray-800">Snapchat Blackout</h3>
                        <p class="text-sm text-gray-600 mt-2">A backend fix on July 11 now requires a <code>scid</code> for Snap events, causing a near-total drop in reported conversions despite good campaign performance before the fix.</p>
                    </div>
                </div>
            </section>

            <!-- Diagnosis Section -->
            <section id="diagnosis-view" class="content-section">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-gray-900">Technical Root Cause Analysis</h2>
                    <p class="mt-2 text-lg text-gray-600 max-w-3xl mx-auto">This section provides a deep dive into the primary technical failures. The diagram below visualizes the user journey and its critical leakage points.</p>
                </div>

                <div class="kpi-card mb-8">
                    <h3 class="text-xl font-bold text-center mb-6">End-to-End Tracking Flow & Failure Points</h3>
                    <div class="flex flex-col items-center p-4">
                        <div class="diagram-step w-64 bg-green-50 border-green-300"><strong>Ad Click</strong><br><span class="text-xs text-gray-500">fbclid / scid generated</span></div>
                        <div class="diagram-arrow"></div>
                        <div class="diagram-step w-64 relative">
                            Landing & Sign-up
                             <div class="absolute right-full mr-6 w-56 text-right leak-point border-l-0 border-r-3 border-orange-500 pr-4">
                                <p class="font-bold text-orange-600">LEAK #1: Scaleo Redirect</p>
                                <p class="text-xs text-gray-500">The <code>fbclid</code> can be dropped, breaking attribution.</p>
                            </div>
                        </div>
                        <div class="diagram-arrow"></div>
                        <div class="diagram-step w-64 bg-red-50 border-red-300 font-bold">
                            Backend Logic: Check for ID
                        </div>
                        <div class="w-full h-16 relative">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-56 text-left leak-point">
                                <p class="font-bold text-red-600">❌ CRITICAL FLAW</p>
                                <p class="text-xs text-gray-500">If <code>fbclid</code> or <code>scid</code> is missing, the server <strong>BLOCKS</strong> the conversion event entirely. This is the main source of lost data.</p>
                            </div>
                        </div>
                        <div class="diagram-arrow"></div>
                        <div class="diagram-step w-64">
                            <strong>Server-Side CAPI Fire</strong>
                             <div class="absolute right-full mr-6 w-56 text-right leak-point border-l-0 border-r-3 border-orange-500 pr-4">
                                <p class="font-bold text-orange-600">LEAK #2: CAPI Payload</p>
                                <p class="text-xs text-gray-500">The payload is sent but is missing the <code>_fbp</code> parameter, leading to poor matching by Meta.</p>
                            </div>
                        </div>
                         <div class="diagram-arrow"></div>
                        <div class="diagram-step w-64">Meta/Snap Platforms</div>
                    </div>
                </div>

                <div id="accordion-container" class="space-y-4"></div>
            </section>

            <!-- Action Plan Section -->
            <section id="plan-view" class="content-section">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-gray-900">Detailed Action Plan</h2>
                    <p class="mt-2 text-lg text-gray-600 max-w-3xl mx-auto">This is an actionable roadmap. Each task includes the "what," "why," and "how" to ensure clear execution.</p>
                </div>
                
                <div id="action-plan-container" class="space-y-4"></div>
                
                <div class="kpi-card mt-8">
                    <h3 class="text-xl font-bold mb-4">Team Next Steps</h3>
                    <div id="team-steps-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    Chart.register(ChartDataLabels);

    const funnelData = {
        labels: ['Power BI (Truth)', 'Meta Events Mgr (Received)', 'Meta Ads (Attributed)'],
        datasets: [{
            data: [212, 50, 8],
            backgroundColor: [
                'rgba(42, 85, 65, 0.8)', // brand-green
                'rgba(124, 58, 237, 0.7)', // violet
                'rgba(239, 68, 68, 0.7)', // red
            ],
            borderColor: [
                'rgba(42, 85, 65, 1)',
                'rgba(124, 58, 237, 1)',
                'rgba(239, 68, 68, 1)',
            ],
            borderWidth: 1
        }]
    };

    const funnelConfig = {
        type: 'bar',
        data: funnelData,
        options: {
            indexAxis: 'y',
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: 'white',
                    anchor: 'center',
                    align: 'center',
                    font: {
                        weight: 'bold',
                        size: 16,
                    },
                    formatter: (value) => value.toLocaleString()
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Total Conversions (July 10-12)' }
                },
                y: { grid: { display: false } }
            }
        }
    };

    new Chart(document.getElementById('funnelChart'), funnelConfig);

    const diagnosisData = [
        { title: '1. Backend Event Logic Flaw', content: `<strong>Finding:</strong> The backend has a strict rule to ONLY fire a CAPI event if a <code>fbclid</code> or <code>scid</code> is present from the user's session. This is the single largest cause of underreporting.<br><br><strong>Impact:</strong> Any and all valid conversions (registrations, purchases) from users who do not have a click ID cookie are completely ignored by the tracking system. This includes users from organic search, direct traffic, or anyone whose click ID was dropped, leading to a massive discrepancy between actual conversions (Power BI) and what is sent to ad platforms.` },
        { title: '2. CAPI Payload Gaps', content: `<p class="mb-4">The payloads that *are* sent to Meta are incomplete. The provided sample confirms the <code>_fbp</code> parameter is missing.</p>
            <pre class="bg-gray-100 p-2 rounded text-xs">"user_data": {\n  "fbc": "...",\n  "em": "...",\n  "ph": "..."\n} <span class="text-red-500">// _fbp is missing</span></pre>
            <p class="mt-4"><strong>Impact:</strong> Without <code>_fbp</code>, Meta cannot reliably match a server event to a browser session. This destroys deduplication capabilities and significantly lowers the Event Match Quality score to 6.2/10, causing Meta's algorithm to distrust the data it receives.</p>` },
        { title: '3. Attribution & UTM Persistence', content: `<strong>Finding:</strong> The Scaleo middleware used for affiliate tracking is suspected of stripping cookies and UTM parameters, particularly the <code>fbclid</code>. The historical use of a 1-day cookie window also exacerbated data loss.<br><br><strong>Impact:</strong> When attribution parameters are lost mid-funnel, conversions cannot be tied back to the campaigns that generated them. This leads to the massive drop-off seen between events received by Meta's server (50) and those actually attributed in Ads Manager (8).` },
        { title: '4. Snapchat Tracking & Deduplication', content: `<strong>Finding:</strong> The July 11 backend fix made the existing logic flaw even worse for Snapchat by making the <code>scid</code> a strict requirement. Previously, it may have tracked more broadly, but now it discards most conversions.<br><br><strong>Impact:</strong> This explains the sudden and dramatic drop in attributed conversions in Snapchat post-fix, despite campaigns performing well before. The platform is now effectively blind.` },
    ];
    
    const accordionContainer = document.getElementById('accordion-container');
    diagnosisData.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'kpi-card';
        div.innerHTML = `
            <div class="accordion-header flex justify-between items-center">
                <h4 class="text-lg font-semibold">${item.title}</h4>
                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="accordion-content pt-4 text-gray-600">${item.content}</div>`;
        accordionContainer.appendChild(div);
    });

    const getTagClass = (value) => {
        switch (value) {
            case 'High': return 'bg-red-100 text-red-800';
            case 'Med': return 'bg-orange-100 text-orange-800';
            case 'Low': return 'bg-green-100 text-green-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    };

    const actionPlanData = [
        { 
            priority: 'High', title: 'Decouple Backend Logic from Click IDs', impact: 'High', effort: 'Med', owner: 'Omri (Dev)',
            what: 'Modify the core backend logic to fire conversion events for ALL valid conversions, regardless of whether a `fbclid` or `scid` is present.',
            why: 'This is the most critical fix. The current logic actively blocks the majority of conversion signals. This change will allow all real conversions to be sent to the ad platforms, forming the foundation for accurate reporting.',
            how: '1. **Locate Logic:** Find the conditional check in the C# code that wraps the CAPI send function (e.g., `if (player.RegistrationFacebookClickId.Exists) { ... }`).<br>2. **Remove Condition:** Remove this conditional gate. The CAPI function should be called for every completed registration or first-time purchase.<br>3. **Pass Nulls Gracefully:** Ensure that if `fbc` or `scid` is not available, the parameter is simply omitted from the payload, rather than blocking the entire event.'
        },
        { 
            priority: 'High', title: 'Enrich Meta CAPI Payload with _fbp', impact: 'High', effort: 'Low', owner: 'Omri (Dev), Shichao (Frontend)',
            what: 'Capture the `_fbp` cookie value on the frontend and pass it to the backend to be included in the `user_data` object of all Meta CAPI events.',
            why: 'This will fix the deduplication issue and significantly increase the Event Match Quality score from 6.2 to the target of >8.0. A higher EMQ means Meta trusts the data more, leading to better optimization and lower effective CPAs.',
            how: '1. **Frontend (Shichao):** Use JavaScript to read the `_fbp` cookie. Add this value to the data payload that is sent to the backend upon user registration or purchase initiation.<br>2. **Backend (Omri):** Modify the C# model to accept the `fbp` value. Add the `fbp` parameter to the `user_data` object in the Meta CAPI payload construction.'
        },
        { 
            priority: 'Med', title: 'Implement Robust Attribution Parameter Persistence', impact: 'High', effort: 'Med', owner: 'Shichao (Frontend)',
            what: 'Create a first-party cookie to store initial attribution parameters (`fbclid`, `scid`, and initial UTM parameters) upon a user\'s first visit from an ad.',
            why: 'This prevents attribution data from being lost due to redirects (like Scaleo) or session breaks. It ensures that when a conversion happens later, the original source data is still available to be sent in the CAPI payload.',
            how: '1. **Create Script:** Write a JavaScript function that runs on every page load.<br>2. **Check for Parameters:** The function should check the URL for `fbclid`, `scid`, and `utm_` parameters.<br>3. **Set Cookie:** If parameters are found AND your first-party attribution cookie does NOT already exist, write the parameter values into the cookie with a 90-day expiry.'
        },
    ];

    const actionPlanContainer = document.getElementById('action-plan-container');
    actionPlanData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'kpi-card';
        div.innerHTML = `
            <div class="accordion-header flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <span class="px-2 py-1 rounded-full font-bold text-xs ${getTagClass(item.priority)}">${item.priority.toUpperCase()}</span>
                    <h4 class="text-lg font-semibold">${item.title}</h4>
                </div>
                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="accordion-content pt-4 text-gray-600 space-y-4">
                <div><p class="font-semibold text-gray-800">What to do:</p><p class="text-sm">${item.what}</p></div>
                <div><p class="font-semibold text-gray-800">Why it matters:</p><p class="text-sm">${item.why}</p></div>
                <div><p class="font-semibold text-gray-800">How to do it:</p><div class="text-sm">${item.how}</div></div>
                <div class="text-sm mt-4 pt-4 border-t"><strong>Owner:</strong> ${item.owner} | <strong>Impact:</strong> <span class="font-medium ${getTagClass(item.impact)} px-1 rounded">${item.impact}</span> | <strong>Effort:</strong> <span class="font-medium ${getTagClass(item.effort)} px-1 rounded">${item.effort}</span></div>
            </div>`;
        actionPlanContainer.appendChild(div);
    });

    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            const svg = header.querySelector('svg');
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                svg.classList.remove('rotate-180');
            } else {
                document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                document.querySelectorAll('.accordion-header svg').forEach(s => s.classList.remove('rotate-180'));
                content.style.maxHeight = content.scrollHeight + "px";
                svg.classList.add('rotate-180');
            }
        });
    });

    const teamStepsData = [
        { team: 'Backend Dev', lead: 'Omri', tasks: ['Lead the implementation of the "Decouple Backend Logic" fix.', 'Update CAPI payload C# code to accept and include the `_fbp` parameter from the frontend.'] },
        { team: 'Frontend Dev', lead: 'Shichao Wang', tasks: ['Implement the JavaScript logic to capture `_fbp` and pass it to the backend.', 'Develop the first-party cookie script for attribution parameter persistence.'] },
        { team: 'Snapchat Dev', lead: 'Oleh L.', tasks: ['Work with Omri to ensure the Snapchat CAPI payload is corrected once the backend logic is decoupled, ensuring it no longer requires a `scid` to fire.'] },
        { team: 'Analytics', lead: 'Shakti', tasks: ['Prepare baseline reports in Power BI to validate the impact of the fixes once they are deployed.', 'Work with the dev team to confirm all necessary data points for BI are preserved.'] },
        { team: 'Marketing Ops', lead: 'Polina Sadonova', tasks: ['Coordinate deployment windows between the dev, frontend, and paid media teams.', 'Oversee the QA and validation process post-deployment.'] },
    ];

    const teamStepsContainer = document.getElementById('team-steps-container');
    teamStepsData.forEach(team => {
        const card = document.createElement('div');
        card.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
        let tasksHTML = team.tasks.map(t => `<li class="text-gray-600">${t}</li>`).join('');
        card.innerHTML = `
            <h4 class="font-bold text-gray-800">${team.team}</h4>
            <p class="text-xs text-gray-500 font-semibold">Lead Contact: ${team.lead}</p>
            <ul class="list-decimal list-inside mt-2 space-y-1 text-sm">${tasksHTML}</ul>`;
        teamStepsContainer.appendChild(card);
    });

    const navItems = document.querySelectorAll('.nav-item');
    const contentSections = document.querySelectorAll('.content-section');

    document.getElementById('main-nav').addEventListener('click', (e) => {
        if (e.target.classList.contains('nav-item')) {
            const view = e.target.dataset.view;
            navItems.forEach(item => item.classList.remove('active'));
            e.target.classList.add('active');
            contentSections.forEach(section => {
                section.classList.remove('active');
                if (section.id === `${view}-view`) {
                    section.classList.add('active');
                }
            });
        }
    });
});
</script>
</body>
</html>
